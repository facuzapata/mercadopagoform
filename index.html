<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <title>Pago con tarjeta</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        .field {
            margin-bottom: 8px;
        }

        .field input,
        .field select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        button {
            background-color: #009ee3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <form id="form-checkout">
        <div class="field">
            <input id="form-checkout__cardholderName" placeholder="Nombre del titular" />
        </div>
        <div class="field">
            <input id="form-checkout__cardNumber" placeholder="Número de tarjeta" />
        </div>
        <div class="field">
            <input id="form-checkout__expirationDate" placeholder="MM/YY" />
        </div>
        <div class="field">
            <input id="form-checkout__securityCode" placeholder="CVV" />
        </div>
        <div class="field">
            <select id="form-checkout__identificationType">
                <option value="">Tipo de documento</option>
            </select>
        </div>
        <div class="field">
            <input id="form-checkout__identificationNumber" placeholder="DNI" />
        </div>
        <div class="field">
            <select id="form-checkout__installments">
                <option value="">Cuotas</option>
            </select>
        </div>
        <button type="submit" id="submit">Pagar</button>
    </form>

    <script>
        const PUBLIC_KEY = 'APP_USR-03f91d11-09d8-4c9f-938e-88e3cd357cf1';

        // Verificar que el SDK se cargó correctamente
        if (typeof MercadoPago === 'undefined') {
            console.error('MercadoPago SDK no se cargó correctamente');
            alert('Error: No se pudo cargar el SDK de MercadoPago');
        } else {
            console.log('MercadoPago SDK cargado correctamente');
        }

        const mp = new MercadoPago(PUBLIC_KEY, {
            locale: 'es-AR',
            advancedFraudPrevention: true
        });

        const cardForm = mp.cardForm({
            amount: '10.00',
            autoMount: true,
            form: {
                id: 'form-checkout',
                cardholderName: {
                    id: 'form-checkout__cardholderName',
                    placeholder: 'Nombre del titular'
                },
                cardNumber: {
                    id: 'form-checkout__cardNumber',
                    placeholder: 'Número de tarjeta'
                },
                expirationDate: {
                    id: 'form-checkout__expirationDate',
                    placeholder: 'MM/YY'
                },
                securityCode: {
                    id: 'form-checkout__securityCode',
                    placeholder: 'CVV'
                },
                identificationType: {
                    id: 'form-checkout__identificationType'
                },
                identificationNumber: {
                    id: 'form-checkout__identificationNumber',
                    placeholder: 'DNI'
                },
                installments: {
                    id: 'form-checkout__installments'
                }
            },
            callbacks: {
                onFormMounted: error => {
                    if (error) {
                        console.error('Error al montar el formulario:', error);
                        alert('Error al cargar el formulario de pago');
                    } else {
                        console.log('CardForm montado correctamente');
                    }
                },
                onReady: () => {
                    console.log('CardForm listo para usar');
                },
                onFormUnmounted: error => {
                    if (error) console.error('Error al desmontar:', error);
                },
                onIdentificationTypesReceived: (error, identificationTypes) => {
                    if (error) {
                        console.error('Error al obtener tipos de identificación:', error);
                    } else {
                        console.log('Tipos de identificación recibidos:', identificationTypes);
                    }
                },
                onPaymentMethodsReceived: (error, paymentMethods) => {
                    if (error) {
                        console.error('Error al obtener métodos de pago:', error);
                    } else {
                        console.log('Métodos de pago recibidos:', paymentMethods);
                    }
                },
                onInstallmentsReceived: (error, installments) => {
                    if (error) {
                        console.error('Error al obtener cuotas:', error);
                    } else {
                        console.log('Cuotas recibidas:', installments);
                    }
                },
                onCardTokenReceived: (error, token) => {
                    if (error) {
                        console.error('Error al obtener token:', error);
                    } else {
                        console.log('Token recibido:', token);
                    }
                },
                onSubmit: async event => {
                    event.preventDefault();

                    try {
                        const data = cardForm.getCardFormData();
                        console.log('Datos del formulario:', data);

                        if (!data.token) {
                            alert('Error: No se pudo generar el token de pago');
                            return;
                        }

                        const payload = {
                            userId: 9,
                            courseId: 'zwx9hi2a111ow1o0pc8oggoo',
                            mercadoPagoTokenId: data.token,
                            paymentMethodId: data.paymentMethodId,
                            installments: Number(data.installments) || 1,
                            paymentType: 'credit_card',
                            payerIdentificationType: data.identificationType,
                            payerIdentificationNumber: data.identificationNumber
                        };

                        console.log('Payload enviado:', payload);

                        const res = await fetch('http://localhost:1337/api/mercadopago/payment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const json = await res.json();
                        console.log('Respuesta backend:', json);

                        if (json.success) {
                            alert('Pago procesado exitosamente!');
                        } else {
                            alert('Error en el pago: ' + (json.message || 'Error desconocido'));
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error al procesar el pago');
                    }
                }
            }
        });
    </script>
</body>

</html>