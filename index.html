<!doctype html>
<html lang="es">

<head>
    <meta charset="utf-8" />
    <title>Pago con tarjeta</title>
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <style>
        /* estilos mínimos para inputs */
        .field {
            margin-bottom: 8px;
        }
    </style>
</head>

<body>
    <form id="form-checkout">
        <div class="field"><input id="form-checkout__cardholderName" placeholder="Nombre del titular" /></div>
        <div class="field"><input id="form-checkout__cardNumber" placeholder="Número de tarjeta" /></div>
        <div class="field"><input id="form-checkout__expirationDate" placeholder="MM/YY" /></div>
        <div class="field"><input id="form-checkout__securityCode" placeholder="CVV" /></div>
        <div class="field">
            <select id="form-checkout__identificationType"></select>
        </div>
        <div class="field"><input id="form-checkout__identificationNumber" placeholder="DNI" /></div>
        <div class="field">
            <select id="form-checkout__installments"></select>
        </div>
        <button type="submit" id="submit">Pagar</button>
    </form>

    <script>
        const PUBLIC_KEY = 'APP_USR-03f91d11-09d8-4c9f-938e-88e3cd357cf1'; // mismo ambiente que el access token del backend
        const mp = new MercadoPago(PUBLIC_KEY, { locale: 'es-AR' });

        const cardForm = mp.cardForm({
            amount: '10.00',
            autoMount: true,
            form: {
                id: 'form-checkout',
                cardholderName: { id: 'form-checkout__cardholderName' },
                cardNumber: { id: 'form-checkout__cardNumber' },
                expirationDate: { id: 'form-checkout__expirationDate' },
                securityCode: { id: 'form-checkout__securityCode' },
                identificationType: { id: 'form-checkout__identificationType' },
                identificationNumber: { id: 'form-checkout__identificationNumber' },
                installments: { id: 'form-checkout__installments' }
            },
            callbacks: {
                onFormMounted: error => {
                    if (error) console.warn('Formulario no montado', error);
                    else console.log('CardForm montado correctamente');
                },
                onSubmit: async event => {
                    event.preventDefault();

                    try {
                        const data = cardForm.getCardFormData();
                        console.log('Datos del formulario:', data);

                        // Payload corregido para coincidir con tu backend
                        const payload = {
                            userId: 9,
                            courseId: 'zwx9hi2a111ow1o0pc8oggoo',
                            mercadoPagoTokenId: data.token,
                            paymentMethodId: data.paymentMethodId,
                            installments: Number(data.installments) || 1,
                            paymentType: 'credit_card',
                            payerIdentificationType: data.identificationType,
                            payerIdentificationNumber: data.identificationNumber
                        };

                        console.log('Payload enviado:', payload);

                        // Cambia esta URL por tu backend real
                        const res = await fetch('http://localhost:1337/api/mercadopago/payment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        const json = await res.json();
                        console.log('Respuesta backend:', json);

                        if (json.success) {
                            alert('Pago procesado exitosamente!');
                        } else {
                            alert('Error en el pago: ' + (json.message || 'Error desconocido'));
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Error al procesar el pago');
                    }
                }
            }
        });
    </script>
</body>

</html>